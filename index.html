<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üåæ Campo 4.0 - Gesti√≥n Integral</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg:#020617;
      --bg-soft:#020617;
      --panel:#0b1120;
      --card:#020617;
      --accent:#22c55e;
      --accent-soft:#16a34a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#1e293b;
      --danger:#ef4444;
      --warn:#facc15;
      --ok:#22c55e;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{
      background:radial-gradient(circle at top,#0f172a 0,#020617 50%,#000 100%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    header{
      padding:10px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background:rgba(15,23,42,.9);
      backdrop-filter:blur(12px);
      position:sticky;
      top:0;
      z-index:50;
    }
    header .title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:600;
    }
    header .title span.logo{
      width:32px;
      height:32px;
      border-radius:10px;
      background:conic-gradient(from 120deg,var(--accent),#4ade80,#22c55e,#166534,var(--accent));
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      box-shadow:0 0 15px rgba(34,197,94,.5);
    }
    header small{
      color:var(--muted);
      font-size:11px;
      display:block;
    }
    .top-right{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      color:var(--muted);
    }
    .pill{
      border-radius:24px;
      border:1px solid var(--border);
      padding:4px 10px;
      display:flex;
      align-items:center;
      gap:6px;
      background:rgba(15,23,42,.8);
    }
    .pill strong{color:var(--accent);font-size:12px;}
    .container{
      flex:1;
      display:flex;
      overflow:hidden;
    }
    nav{
      width:250px;
      border-right:1px solid var(--border);
      padding:10px;
      background:rgba(15,23,42,.92);
      backdrop-filter:blur(10px);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .nav-group-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin:8px 6px 4px;
    }
    .nav-btn{
      width:100%;
      border-radius:8px;
      padding:7px 8px;
      border:1px solid transparent;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      text-align:left;
    }
    .nav-btn span.emoji{width:20px;text-align:center;}
    .nav-btn.active{
      background:linear-gradient(90deg,rgba(34,197,94,.18),rgba(15,23,42,0.6));
      border-color:rgba(34,197,94,.4);
      color:var(--text);
      box-shadow:0 0 0 1px rgba(34,197,94,.2);
    }
    .nav-btn:hover{
      background:rgba(15,23,42,.8);
      color:var(--text);
    }
    main{
      flex:1;
      padding:12px;
      overflow-y:auto;
    }
    .view{display:none;animation:fadeIn .22s ease-out;}
    .view.active{display:block;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:translateY(0);}}
    h1,h2,h3{font-weight:600;}
    h1{font-size:20px;margin-bottom:4px;}
    h2{font-size:18px;margin:12px 0 6px;}
    h3{font-size:15px;margin:10px 0 4px;}
    .subtitle{font-size:12px;color:var(--muted);margin-bottom:10px;}
    .grid{
      display:grid;
      gap:10px;
    }
    @media(min-width:900px){
      .grid-3{grid-template-columns:repeat(3,minmax(0,1fr));}
      .grid-2{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    .card{
      background:radial-gradient(circle at top left,rgba(34,197,94,.06),rgba(15,23,42,1));
      border-radius:12px;
      border:1px solid var(--border);
      padding:10px;
      box-shadow:0 18px 40px rgba(15,23,42,.8);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
      font-size:13px;
    }
    .card-header span.label{
      font-size:11px;
      color:var(--muted);
    }
    .kpi{
      font-size:20px;
      font-weight:600;
    }
    .kpi span.small{
      font-size:11px;
      color:var(--muted);
      font-weight:400;
      margin-left:4px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:10px;
      border-radius:999px;
      padding:2px 8px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.8);
      color:var(--muted);
    }
    .tag.ok{border-color:rgba(34,197,94,.6);color:var(--ok);}
    .tag.warn{border-color:rgba(250,204,21,.6);color:var(--warn);}
    .tag.danger{border-color:rgba(239,68,68,.6);color:var(--danger);}
    .btn{
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 11px;
      font-size:12px;
      background:rgba(15,23,42,.9);
      color:var(--text);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-primary{
      border-color:rgba(34,197,94,.8);
      background:linear-gradient(135deg,var(--accent),var(--accent-soft));
      color:#02130a;
      box-shadow:0 0 18px rgba(34,197,94,.5);
    }
    .btn-sm{padding:4px 8px;font-size:11px;}
    .btn + .btn{margin-left:6px;}
    .btn:hover{filter:brightness(1.05);}
    .btn-icon{width:18px;text-align:center;}
    form{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:8px;
      margin-bottom:8px;
      font-size:12px;
    }
    label{
      display:flex;
      flex-direction:column;
      gap:3px;
      font-size:11px;
      color:var(--muted);
    }
    input,select,textarea{
      border-radius:7px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.85);
      padding:5px 7px;
      color:var(--text);
      font-size:12px;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(34,197,94,.4);
    }
    textarea{min-height:60px;resize:vertical;}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin-top:4px;
    }
    th,td{
      border-bottom:1px solid rgba(30,41,59,.7);
      padding:4px 4px;
      text-align:left;
      white-space:nowrap;
    }
    th{
      color:var(--muted);
      font-weight:500;
      position:sticky;
      top:0;
      backdrop-filter:blur(8px);
      background:rgba(15,23,42,.98);
      z-index:5;
    }
    tbody tr:hover{
      background:rgba(15,23,42,.8);
    }
    .table-wrapper{
      max-height:260px;
      overflow:auto;
      border-radius:8px;
      border:1px solid var(--border);
      margin-top:4px;
    }
    .actions{
      display:flex;
      gap:4px;
    }
    .text-right{text-align:right;}
    .text-center{text-align:center;}
    .muted{color:var(--muted);font-size:11px;}
    .badge{
      border-radius:999px;
      padding:2px 7px;
      font-size:10px;
      border:1px solid var(--border);
      display:inline-block;
    }
    .badge.green{border-color:rgba(34,197,94,.7);color:var(--ok);}
    .badge.red{border-color:rgba(239,68,68,.7);color:var(--danger);}
    .badge.yellow{border-color:rgba(250,204,21,.7);color:var(--warn);}
    .flex{display:flex;align-items:center;gap:6px;}
    .flex-between{display:flex;align-items:center;justify-content:space-between;}
    .mt-4{margin-top:4px;}
    .mt-6{margin-top:6px;}
    .mt-8{margin-top:8px;}
    .mt-12{margin-top:12px;}
    .chip-filter{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:11px;
      cursor:pointer;
      background:rgba(15,23,42,.7);
      color:var(--muted);
    }
    .chip-filter.active{
      border-color:rgba(34,197,94,.7);
      color:var(--ok);
      box-shadow:0 0 0 1px rgba(34,197,94,.3);
    }
    .scroll-x{overflow-x:auto;}
    .text-accent{color:var(--accent);}
    footer{
      font-size:10px;
      color:var(--muted);
      text-align:center;
      padding:4px 0 6px;
      border-top:1px solid var(--border);
      background:rgba(15,23,42,.95);
    }
    @media(max-width:750px){
      nav{width:78px;}
      .nav-group-title{display:none;}
      .nav-btn span.label{display:none;}
    }

    /* Mapa visual de lotes */
    .lotes-map{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .lote-box{
      flex:1 1 90px;
      min-width:90px;
      border-radius:8px;
      padding:6px;
      border:1px solid var(--border);
      font-size:10px;
      background:rgba(15,23,42,.9);
    }
    .lote-box strong{font-size:11px;}
    .lote-agricola{background:radial-gradient(circle at top,#064e3b,#022c22);}
    .lote-ganadero{background:radial-gradient(circle at top,#1e3a8a,#020617);}
    .lote-barbecho{background:radial-gradient(circle at top,#78350f,#111827);}
    .lote-otro{background:radial-gradient(circle at top,#4b5563,#020617);}
  </style>
</head>
<body>
<header>
  <div class="title">
    <span class="logo">üåæ</span>
    <div>
      Campo 4.0
      <small>Gesti√≥n integral agr√≠cola & ganadera (localStorage)</small>
    </div>
  </div>
  <div class="top-right">
    <div class="pill">
      <span>üìÖ</span>
      <div>
        <span id="header-date">--</span><br>
        <small id="header-time">--:--</small>
      </div>
    </div>
    <div class="pill">
      <span>üíæ</span><strong>LocalStorage</strong>
    </div>
    <button class="btn btn-sm" onclick="toggleFullscreen()">
      <span class="btn-icon">üñ•Ô∏è</span><span id="fs-label">Full</span>
    </button>
  </div>
</header>

<div class="container">
  <nav>
    <div class="nav-group-title">Principal</div>
    <button class="nav-btn active" data-view="dashboard">
      <span class="emoji">üìä</span><span class="label">Dashboard</span>
    </button>
    <button class="nav-btn" data-view="lotes">
      <span class="emoji">üó∫Ô∏è</span><span class="label">Lotes</span>
    </button>
    <button class="nav-btn" data-view="labores">
      <span class="emoji">üß∞</span><span class="label">Labores</span>
    </button>
    <button class="nav-btn" data-view="insumos">
      <span class="emoji">üß™</span><span class="label">Insumos</span>
    </button>

    <div class="nav-group-title">Operaci√≥n</div>
    <button class="nav-btn" data-view="maquinaria">
      <span class="emoji">üöú</span><span class="label">Maquinaria</span>
    </button>
    <button class="nav-btn" data-view="personal">
      <span class="emoji">üë®‚Äçüåæ</span><span class="label">Personal</span>
    </button>
    <button class="nav-btn" data-view="ganaderia">
      <span class="emoji">üêÑ</span><span class="label">Ganader√≠a</span>
    </button>
    <button class="nav-btn" data-view="finanzas">
      <span class="emoji">üí∏</span><span class="label">Finanzas</span>
    </button>

    <div class="nav-group-title">Sistema</div>
    <button class="nav-btn" data-view="config">
      <span class="emoji">‚öôÔ∏è</span><span class="label">Config & Backup</span>
    </button>
  </nav>

  <main>
    <!-- DASHBOARD -->
    <section id="view-dashboard" class="view active">
      <h1>üìä Dashboard general</h1>
      <p class="subtitle">Vista r√°pida de c√≥mo viene el campo hoy.</p>

      <div class="grid grid-3 mt-6">
        <div class="card">
          <div class="card-header">
            <span class="label">Lotes activos</span>
            <span class="tag" id="dash-campaign-tag">Campa√±a actual</span>
          </div>
          <div class="kpi" id="dash-lotes-count">0</div>
          <div class="muted mt-4">Lotes registrados en el sistema.</div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="label">Labores pendientes</span>
            <span class="tag warn">‚è≥ Pendientes</span>
          </div>
          <div class="kpi" id="dash-labores-pendientes">0</div>
          <div class="muted mt-4">Tareas que todav√≠a no se marcaron como finalizadas.</div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="label">Stock cr√≠tico</span>
            <span class="tag danger">‚ö†Ô∏è Bajo stock</span>
          </div>
          <div class="kpi" id="dash-insumos-criticos">0</div>
          <div class="muted mt-4">Insumos por debajo del stock m√≠nimo.</div>
        </div>
      </div>

      <div class="grid grid-2 mt-8">
        <div class="card">
          <div class="card-header">
            <div class="flex">
              <span>üîî Alertas r√°pidas</span>
              <span class="badge yellow" id="dash-alert-count">0 activas</span>
            </div>
            <button class="btn btn-sm" onclick="goToView('config')">
              <span class="btn-icon">‚öôÔ∏è</span>Configurar campa√±a
            </button>
          </div>
          <ul id="dash-alert-list" class="muted" style="list-style:none;display:flex;flex-direction:column;gap:4px;">
          </ul>
        </div>

        <div class="card">
          <div class="card-header">
            <span>üìÖ Pr√≥ximas labores</span>
            <span class="label">Siguientes 7 d√≠as</span>
          </div>
          <div class="table-wrapper" style="max-height:200px;">
            <table>
              <thead>
              <tr>
                <th>Fecha</th>
                <th>Lote</th>
                <th>Tipo</th>
                <th>Estado</th>
              </tr>
              </thead>
              <tbody id="dash-proximas-labores"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Gr√°ficos dashboard -->
      <div class="grid grid-2 mt-8">
        <div class="card">
          <div class="card-header">
            <span>üå± Rendimiento promedio por lote</span>
            <span class="label">qq/ha</span>
          </div>
          <canvas id="chart-rinde-lotes" style="max-height:260px;"></canvas>
        </div>
        <div class="card">
          <div class="card-header">
            <span>üí∞ Ingresos vs egresos</span>
            <span class="label" id="chart-fin-label">Campa√±a actual</span>
          </div>
          <canvas id="chart-finanzas" style="max-height:260px;"></canvas>
        </div>
      </div>
    </section>

    <!-- LOTES -->
    <section id="view-lotes" class="view">
      <h1>üó∫Ô∏è Lotes / Cuadros</h1>
      <p class="subtitle">Administr√° los lotes del campo, superficie y uso actual.</p>

      <div class="card mt-6">
        <div class="card-header">
          <span>‚ûï Lote nuevo / editar</span>
          <span class="label" id="lotes-form-mode">Alta</span>
        </div>
        <form id="form-lote">
          <input type="hidden" id="lote-id">
          <label>
            Nombre del lote
            <input id="lote-nombre" required placeholder="Ej: Lote 1 Norte">
          </label>
          <label>
            Superficie (ha)
            <input id="lote-superficie" type="number" step="0.01" min="0">
          </label>
          <label>
            Tipo de suelo
            <input id="lote-suelo" placeholder="Franco, arenoso, etc.">
          </label>
          <label>
            Uso actual / cultivo
            <input id="lote-uso" placeholder="Soja, ma√≠z, pastura, barbecho...">
          </label>
          <label>
            √öltimo cultivo
            <input id="lote-ultimo-cultivo" placeholder="Ej: Soja 2¬™">
          </label>
          <label>
            Fecha siembra (√∫ltima)
            <input id="lote-fecha-siembra" type="date">
          </label>
          <label>
            Fecha cosecha (√∫ltima)
            <input id="lote-fecha-cosecha" type="date">
          </label>
          <label>
            Rendimiento promedio (qq/ha)
            <input id="lote-rinde" type="number" step="0.01" min="0">
          </label>
        </form>
        <div class="mt-4">
          <button class="btn btn-primary btn-sm" onclick="saveLote()">üíæ Guardar lote</button>
          <button class="btn btn-sm" onclick="resetLoteForm()">üßπ Limpiar</button>
        </div>
      </div>

      <div class="card mt-8">
        <div class="flex-between">
          <div class="card-header" style="margin-bottom:0;">
            <span>Lotes registrados</span>
          </div>
          <div class="flex">
            <span class="muted">Filtro uso:</span>
            <button class="chip-filter active" data-filter-lote="all" onclick="filterLotes('all',event)">Todos</button>
            <button class="chip-filter" data-filter-lote="agricola" onclick="filterLotes('agricola',event)">Agr√≠cola</button>
            <button class="chip-filter" data-filter-lote="ganadero" onclick="filterLotes('ganadero',event)">Ganadero</button>
          </div>
        </div>
        <div class="table-wrapper mt-4">
          <table>
            <thead>
            <tr>
              <th>Nombre</th>
              <th>ha</th>
              <th>Uso actual</th>
              <th>√öltimo cultivo</th>
              <th>Rinde (qq/ha)</th>
              <th>Acciones</th>
            </tr>
            </thead>
            <tbody id="tabla-lotes"></tbody>
          </table>
        </div>
      </div>

      <!-- Mapa visual -->
      <div class="card mt-8">
        <div class="card-header">
          <span>üó∫Ô∏è Mapa visual simple de lotes</span>
          <span class="label">Colores seg√∫n uso</span>
        </div>
        <div class="lotes-map" id="lotes-map-grid"></div>
        <div class="muted mt-6">
          Verde: agr√≠cola ¬∑ Azul: ganadero/pastoreo ¬∑ Marr√≥n: barbecho ¬∑ Gris: otros usos.
        </div>
      </div>
    </section>

    <!-- LABORES -->
    <section id="view-labores" class="view">
      <h1>üß∞ Labores</h1>
      <p class="subtitle">Planific√° y registr√° siembras, pulverizaciones, fertilizaci√≥n, cosecha y m√°s.</p>

      <div class="card mt-6">
        <div class="card-header">
          <span>‚ûï Nueva labor / editar</span>
          <span class="label" id="labores-form-mode">Alta</span>
        </div>
        <form id="form-labor">
          <input type="hidden" id="labor-id">
          <label>
            Lote
            <select id="labor-lote" required></select>
          </label>
          <label>
            Tipo de labor
            <select id="labor-tipo">
              <option value="Siembra">Siembra</option>
              <option value="Fertilizaci√≥n">Fertilizaci√≥n</option>
              <option value="Pulverizaci√≥n">Pulverizaci√≥n</option>
              <option value="Cosecha">Cosecha</option>
              <option value="Rastra/Preparaci√≥n">Rastra / Preparaci√≥n</option>
              <option value="Riego">Riego</option>
              <option value="Otro">Otro</option>
            </select>
          </label>
          <label>
            Fecha planificada
            <input id="labor-fecha-plan" type="date">
          </label>
          <label>
            Fecha realizada
            <input id="labor-fecha-real" type="date">
          </label>
          <label>
            Estado
            <select id="labor-estado">
              <option value="Pendiente">Pendiente</option>
              <option value="En proceso">En proceso</option>
              <option value="Finalizada">Finalizada</option>
            </select>
          </label>
          <label>
            Maquinaria
            <select id="labor-maquina"></select>
          </label>
          <label>
            Operario
            <select id="labor-operario"></select>
          </label>
          <label>
            Horas de m√°quina
            <input id="labor-horas" type="number" step="0.1" min="0">
          </label>
          <label>
            Combustible (L)
            <input id="labor-combustible" type="number" step="0.1" min="0">
          </label>
          <label style="grid-column:1/-1;">
            Observaciones
            <textarea id="labor-obs" placeholder="Detalles relevantes de la labor..."></textarea>
          </label>
        </form>
        <div class="mt-4">
          <button class="btn btn-primary btn-sm" onclick="saveLabor()">üíæ Guardar labor</button>
          <button class="btn btn-sm" onclick="resetLaborForm()">üßπ Limpiar</button>
        </div>
      </div>

      <div class="card mt-8">
        <div class="flex-between">
          <div class="card-header" style="margin-bottom:0;">
            <span>Labores registradas</span>
          </div>
          <div class="flex">
            <span class="muted">Estado:</span>
            <button class="chip-filter active" data-filter-labor="all" onclick="filterLabores('all',event)">Todas</button>
            <button class="chip-filter" data-filter-labor="Pendiente" onclick="filterLabores('Pendiente',event)">Pendientes</button>
            <button class="chip-filter" data-filter-labor="En proceso" onclick="filterLabores('En proceso',event)">En proceso</button>
            <button class="chip-filter" data-filter-labor="Finalizada" onclick="filterLabores('Finalizada',event)">Finalizadas</button>
          </div>
        </div>
        <div class="table-wrapper mt-4 scroll-x">
          <table>
            <thead>
            <tr>
              <th>Fecha plan</th>
              <th>Lote</th>
              <th>Tipo</th>
              <th>Estado</th>
              <th>Operario</th>
              <th>Maquinaria</th>
              <th>Horas</th>
              <th>Comb.</th>
              <th>Acciones</th>
            </tr>
            </thead>
            <tbody id="tabla-labores"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- INSUMOS -->
    <section id="view-insumos" class="view">
      <h1>üß™ Insumos</h1>
      <p class="subtitle">Control√° stock de semillas, fertilizantes, fitosanitarios y m√°s.</p>

      <div class="card mt-6">
        <div class="card-header">
          <span>‚ûï Insumo nuevo / editar</span>
          <span class="label" id="insumos-form-mode">Alta</span>
        </div>
        <form id="form-insumo">
          <input type="hidden" id="insumo-id">
          <label>
            Nombre del insumo
            <input id="insumo-nombre" required placeholder="Ej: Urea 46%">
          </label>
          <label>
            Categor√≠a
            <select id="insumo-categoria">
              <option value="Semilla">Semilla</option>
              <option value="Fertilizante">Fertilizante</option>
              <option value="Herbicida">Herbicida</option>
              <option value="Fungicida">Fungicida</option>
              <option value="Insecticida">Insecticida</option>
              <option value="Combustible">Combustible</option>
              <option value="Repuesto">Repuesto</option>
              <option value="Otro">Otro</option>
            </select>
          </label>
          <label>
            Unidad
            <input id="insumo-unidad" placeholder="kg, L, bolsa, bid√≥n...">
          </label>
          <label>
            Stock actual
            <input id="insumo-stock" type="number" step="0.01" min="0">
          </label>
          <label>
            Stock m√≠nimo
            <input id="insumo-minimo" type="number" step="0.01" min="0">
          </label>
          <label>
            Costo unitario (USD)
            <input id="insumo-costo" type="number" step="0.01" min="0">
          </label>
        </form>
        <div class="mt-4">
          <button class="btn btn-primary btn-sm" onclick="saveInsumo()">üíæ Guardar insumo</button>
          <button class="btn btn-sm" onclick="resetInsumoForm()">üßπ Limpiar</button>
        </div>
      </div>

      <div class="card mt-8">
        <div class="flex-between">
          <div class="card-header" style="margin-bottom:0;">
            <span>Stock de insumos</span>
          </div>
          <div class="flex">
            <span class="muted">Categor√≠a:</span>
            <button class="chip-filter active" data-filter-insumo="all" onclick="filterInsumos('all',event)">Todas</button>
            <button class="chip-filter" data-filter-insumo="Semilla" onclick="filterInsumos('Semilla',event)">Semillas</button>
            <button class="chip-filter" data-filter-insumo="Fertilizante" onclick="filterInsumos('Fertilizante',event)">Fertilizantes</button>
            <button class="chip-filter" data-filter-insumo="Herbicida" onclick="filterInsumos('Herbicida',event)">Herbicidas</button>
          </div>
        </div>
        <div class="table-wrapper mt-4 scroll-x">
          <table>
            <thead>
            <tr>
              <th>Nombre</th>
              <th>Categor√≠a</th>
              <th>Stock</th>
              <th>M√≠nimo</th>
              <th>Unidad</th>
              <th>Costo u.</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
            </thead>
            <tbody id="tabla-insumos"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- MAQUINARIA -->
    <section id="view-maquinaria" class="view">
      <h1>üöú Maquinaria & Mantenimiento</h1>
      <p class="subtitle">Tractores, cosechadoras, pulverizadoras y sus servicios.</p>

      <div class="card mt-6">
        <div class="card-header">
          <span>‚ûï Maquinaria nueva / editar</span>
          <span class="label" id="maq-form-mode">Alta</span>
        </div>
        <form id="form-maq">
          <input type="hidden" id="maq-id">
          <label>
            Nombre / Alias
            <input id="maq-nombre" placeholder="Tractor John Deere 1" required>
          </label>
          <label>
            Tipo
            <select id="maq-tipo">
              <option value="Tractor">Tractor</option>
              <option value="Cosechadora">Cosechadora</option>
              <option value="Pulverizadora">Pulverizadora</option>
              <option value="Cami√≥n">Cami√≥n</option>
              <option value="Implemento">Implemento</option>
              <option value="Otro">Otro</option>
            </select>
          </label>
          <label>
            Marca
            <input id="maq-marca">
          </label>
          <label>
            Modelo
            <input id="maq-modelo">
          </label>
          <label>
            A√±o
            <input id="maq-anio" type="number" min="1950" max="2100">
          </label>
          <label>
            Horas actuales
            <input id="maq-horas" type="number" step="1" min="0">
          </label>
          <label>
            Pr√≥x. service (horas)
            <input id="maq-next-service" type="number" step="1" min="0">
          </label>
          <label style="grid-column:1/-1;">
            Notas
            <textarea id="maq-notas"></textarea>
          </label>
        </form>
        <div class="mt-4">
          <button class="btn btn-primary btn-sm" onclick="saveMaquinaria()">üíæ Guardar equipo</button>
          <button class="btn btn-sm" onclick="resetMaquinariaForm()">üßπ Limpiar</button>
        </div>
      </div>

      <div class="card mt-8">
        <div class="card-header">
          <span>Maquinaria registrada</span>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
            <tr>
              <th>Nombre</th>
              <th>Tipo</th>
              <th>Horas</th>
              <th>Pr√≥x. service</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
            </thead>
            <tbody id="tabla-maquinaria"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PERSONAL -->
    <section id="view-personal" class="view">
      <h1>üë®‚Äçüåæ Personal</h1>
      <p class="subtitle">Puestero, tractorista, encargado, etc.</p>

      <div class="card mt-6">
        <div class="card-header">
          <span>‚ûï Operario nuevo / editar</span>
          <span class="label" id="personal-form-mode">Alta</span>
        </div>
        <form id="form-personal">
          <input type="hidden" id="pers-id">
          <label>
            Nombre y apellido
            <input id="pers-nombre" required>
          </label>
          <label>
            Rol
            <select id="pers-rol">
              <option value="Tractorista">Tractorista</option>
              <option value="Puestero">Puestero</option>
              <option value="Encargado">Encargado</option>
              <option value="Administraci√≥n">Administraci√≥n</option>
              <option value="Otro">Otro</option>
            </select>
          </label>
          <label>
            Tel√©fono
            <input id="pers-tel">
          </label>
          <label>
            Notas
            <textarea id="pers-notas"></textarea>
          </label>
        </form>
        <div class="mt-4">
          <button class="btn btn-primary btn-sm" onclick="savePersonal()">üíæ Guardar personal</button>
          <button class="btn btn-sm" onclick="resetPersonalForm()">üßπ Limpiar</button>
        </div>
      </div>

      <div class="card mt-8">
        <div class="card-header">
          <span>Personal registrado</span>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
            <tr>
              <th>Nombre</th>
              <th>Rol</th>
              <th>Tel√©fono</th>
              <th>Acciones</th>
            </tr>
            </thead>
            <tbody id="tabla-personal"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- GANADER√çA -->
    <section id="view-ganaderia" class="view">
      <h1>üêÑ Ganader√≠a</h1>
      <p class="subtitle">Rodeos, potreros y movimientos de hacienda.</p>

      <div class="grid grid-2 mt-6">
        <div class="card">
          <div class="card-header">
            <span>‚ûï Rodeo / grupo</span>
          </div>
          <form id="form-rodeo">
            <input type="hidden" id="rodeo-id">
            <label>
              Nombre del rodeo
              <input id="rodeo-nombre" placeholder="Vacas cr√≠a lote 1">
            </label>
            <label>
              Categor√≠a
              <select id="rodeo-cat">
                <option value="Vacas">Vacas</option>
                <option value="Vaquillonas">Vaquillonas</option>
                <option value="Terneros/as">Terneros/as</option>
                <option value="Toros">Toros</option>
                <option value="Mixto">Mixto</option>
              </select>
            </label>
            <label>
              Potrero / Lote
              <input id="rodeo-potrero">
            </label>
            <label>
              Cantidad actual
              <input id="rodeo-cant" type="number" min="0" step="1">
            </label>
          </form>
          <div class="mt-4">
            <button class="btn btn-primary btn-sm" onclick="saveRodeo()">üíæ Guardar rodeo</button>
            <button class="btn btn-sm" onclick="resetRodeoForm()">üßπ Limpiar</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>‚ûï Movimiento hacienda</span>
          </div>
          <form id="form-mov-ganado">
            <input type="hidden" id="movgan-id">
            <label>
              Fecha
              <input id="movgan-fecha" type="date">
            </label>
            <label>
              Tipo
              <select id="movgan-tipo">
                <option value="Compra">Compra</option>
                <option value="Venta">Venta</option>
                <option value="Muerte">Muerte</option>
                <option value="Nacimientos">Nacimientos</option>
                <option value="Movimiento interno">Movimiento interno</option>
              </select>
            </label>
            <label>
              Rodeo
              <select id="movgan-rodeo"></select>
            </label>
            <label>
              Cantidad
              <input id="movgan-cant" type="number" min="0" step="1">
            </label>
            <label style="grid-column:1/-1;">
              Comentarios
              <textarea id="movgan-notas"></textarea>
            </label>
          </form>
          <div class="mt-4">
            <button class="btn btn-primary btn-sm" onclick="saveMovGanado()">üíæ Guardar movimiento</button>
            <button class="btn btn-sm" onclick="resetMovGanadoForm()">üßπ Limpiar</button>
          </div>
        </div>
      </div>

      <div class="grid grid-2 mt-8">
        <div class="card">
          <div class="card-header">
            <span>Rodeos activos</span>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>Rodeo</th>
                <th>Cat.</th>
                <th>Potrero</th>
                <th>Cant.</th>
                <th>Acc.</th>
              </tr>
              </thead>
              <tbody id="tabla-rodeos"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>Movimientos recientes</span>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Rodeo</th>
                <th>Cant.</th>
                <th>Acc.</th>
              </tr>
              </thead>
              <tbody id="tabla-mov-ganado"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- FINANZAS -->
    <section id="view-finanzas" class="view">
      <h1>üí∏ Finanzas del campo</h1>
      <p class="subtitle">Ingresos, egresos y resultado por campa√±a (simple pero √∫til).</p>

      <div class="grid grid-2 mt-6">
        <div class="card">
          <div class="card-header">
            <span>‚ûï Ingreso</span>
          </div>
          <form id="form-ingreso">
            <input type="hidden" id="ing-id">
            <label>
              Fecha
              <input id="ing-fecha" type="date">
            </label>
            <label>
              Monto (USD)
              <input id="ing-monto" type="number" step="0.01" min="0">
            </label>
            <label>
              Concepto
              <input id="ing-concepto" placeholder="Venta soja, venta novillos...">
            </label>
            <label>
              Campa√±a
              <input id="ing-campana" placeholder="Ej: 24/25">
            </label>
          </form>
          <div class="mt-4">
            <button class="btn btn-primary btn-sm" onclick="saveIngreso()">üíæ Guardar ingreso</button>
            <button class="btn btn-sm" onclick="resetIngresoForm()">üßπ Limpiar</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>‚ûï Egreso</span>
          </div>
          <form id="form-egreso">
            <input type="hidden" id="egr-id">
            <label>
              Fecha
              <input id="egr-fecha" type="date">
            </label>
            <label>
              Monto (USD)
              <input id="egr-monto" type="number" step="0.01" min="0">
            </label>
            <label>
              Concepto
              <input id="egr-concepto" placeholder="Insumos, flete, contratista...">
            </label>
            <label>
              Campa√±a
              <input id="egr-campana" placeholder="Ej: 24/25">
            </label>
          </form>
          <div class="mt-4">
            <button class="btn btn-primary btn-sm" onclick="saveEgreso()">üíæ Guardar egreso</button>
            <button class="btn btn-sm" onclick="resetEgresoForm()">üßπ Limpiar</button>
          </div>
        </div>
      </div>

      <div class="card mt-8">
        <div class="flex-between">
          <div class="card-header" style="margin-bottom:0;">
            <span>Resumen por campa√±a</span>
          </div>
          <div class="flex">
            <label class="muted">
              Campa√±a:
              <input id="fin-campana-filtro" style="margin-left:4px;width:90px;" placeholder="24/25">
            </label>
            <button class="btn btn-sm" onclick="updateFinanzasResumen()">üîÑ Actualizar</button>
          </div>
        </div>
        <div class="grid grid-3 mt-6">
          <div>
            <div class="label">Ingresos</div>
            <div class="kpi" id="fin-kpi-ingresos">0</div>
          </div>
          <div>
            <div class="label">Egresos</div>
            <div class="kpi" id="fin-kpi-egresos">0</div>
          </div>
          <div>
            <div class="label">Resultado</div>
            <div class="kpi" id="fin-kpi-resultado">0</div>
          </div>
        </div>

        <div class="grid grid-2 mt-8">
          <div>
            <h3>Ingresos</h3>
            <div class="table-wrapper">
              <table>
                <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Campa√±a</th>
                  <th>Concepto</th>
                  <th class="text-right">Monto</th>
                  <th>Acc.</th>
                </tr>
                </thead>
                <tbody id="tabla-ingresos"></tbody>
              </table>
            </div>
          </div>
          <div>
            <h3>Egresos</h3>
            <div class="table-wrapper">
              <table>
                <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Campa√±a</th>
                  <th>Concepto</th>
                  <th class="text-right">Monto</th>
                  <th>Acc.</th>
                </tr>
                </thead>
                <tbody id="tabla-egresos"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CONFIG & BACKUP -->
    <section id="view-config" class="view">
      <h1>‚öôÔ∏è Configuraci√≥n & Backup</h1>
      <p class="subtitle">Cambi√° campa√±a actual, descarg√° o import√° backups del campo.</p>

      <div class="grid grid-2 mt-6">
        <div class="card">
          <div class="card-header">
            <span>Campa√±a actual</span>
          </div>
          <label class="mt-4">
            <span style="font-size:11px;color:var(--muted);">Campa√±a (texto libre)</span>
            <input id="cfg-campana" placeholder="Ej: 24/25">
          </label>
          <div class="mt-4">
            <button class="btn btn-primary btn-sm" onclick="saveCampana()">üíæ Guardar campa√±a</button>
          </div>
          <p class="muted mt-6">La campa√±a impacta en el dashboard y en el resumen de finanzas (si el texto coincide).</p>
        </div>

        <div class="card">
          <div class="card-header">
            <span>Backup de datos</span>
          </div>
          <p class="muted mt-4">Todo lo que carg√°s se guarda en el navegador con localStorage.</p>
          <div class="mt-6">
            <button class="btn btn-sm" onclick="downloadBackup()">‚¨áÔ∏è Descargar backup (.json)</button>
          </div>
          <div class="mt-4">
            <label class="btn btn-sm">
              ‚¨ÜÔ∏è Importar backup
              <input type="file" id="backup-file" style="display:none;" accept="application/json" onchange="importBackup(event)">
            </label>
          </div>
          <div class="mt-6">
            <button class="btn btn-sm" style="border-color:rgba(239,68,68,.8);color:var(--danger);" onclick="clearAllData()">üß® Borrar TODO (reset)</button>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<footer>
  Campo 4.0 - App localStorage. Si borr√°s los datos del navegador, vuela todo. Hac√© backup cada tanto. üíæ
</footer>

<!-- Librer√≠a para gr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const STORAGE_KEY = "campo40_localstorage_v1";

  let state = {
    settings:{ campaign:"24/25" },
    lots:[],
    labores:[],
    insumos:[],
    maquinaria:[],
    personal:[],
    rodeos:[],
    movGanado:[],
    ingresos:[],
    egresos:[]
  };

  // --------- CORE LS ----------
  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      try{
        const parsed = JSON.parse(raw);
        state = Object.assign(state, parsed);
      }catch(e){
        console.error("Error parseando LS",e);
      }
    }
  }
  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    updateAllViews();
  }
  function generateId(prefix){
    return prefix + "_" + Date.now().toString(36) + "_" + Math.random().toString(16).slice(2);
  }

  // --------- NAV ----------
  function goToView(view){
    document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
    document.getElementById("view-"+view).classList.add("active");
    document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
    document.querySelector(`.nav-btn[data-view="${view}"]`)?.classList.add("active");
  }
  document.querySelectorAll(".nav-btn").forEach(btn=>{
    btn.addEventListener("click",()=>goToView(btn.dataset.view));
  });

  // --------- FULLSCREEN ----------
  function toggleFullscreen(){
    if(!document.fullscreenElement){
      document.documentElement.requestFullscreen?.().catch(()=>{});
    }else{
      document.exitFullscreen?.();
    }
  }
  document.addEventListener("fullscreenchange",()=>{
    const el = document.getElementById("fs-label");
    if(document.fullscreenElement){
      el.textContent = "Salir";
    }else{
      el.textContent = "Full";
    }
  });

  // --------- HEADER fecha/hora ----------
  function updateDateTime(){
    const now = new Date();
    const dateStr = now.toLocaleDateString("es-AR",{weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"});
    const timeStr = now.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit"});
    document.getElementById("header-date").textContent = dateStr;
    document.getElementById("header-time").textContent = timeStr;
  }
  setInterval(updateDateTime,1000);

  // ========= LOTES =========
  function resetLoteForm(){
    document.getElementById("form-lote").reset();
    document.getElementById("lote-id").value = "";
    document.getElementById("lotes-form-mode").textContent = "Alta";
  }
  function saveLote(){
    const id = document.getElementById("lote-id").value || generateId("lote");
    const obj = {
      id,
      nombre:document.getElementById("lote-nombre").value.trim(),
      superficie:+(document.getElementById("lote-superficie").value || 0),
      suelo:document.getElementById("lote-suelo").value.trim(),
      uso:document.getElementById("lote-uso").value.trim(),
      ultimoCultivo:document.getElementById("lote-ultimo-cultivo").value.trim(),
      fechaSiembra:document.getElementById("lote-fecha-siembra").value,
      fechaCosecha:document.getElementById("lote-fecha-cosecha").value,
      rinde:+(document.getElementById("lote-rinde").value || 0)
    };
    if(!obj.nombre){
      alert("El lote necesita un nombre.");
      return;
    }
    const idx = state.lots.findIndex(l=>l.id===id);
    if(idx>=0) state.lots[idx] = obj; else state.lots.push(obj);
    saveState();
    resetLoteForm();
  }
  function editLote(id){
    const lote = state.lots.find(l=>l.id===id);
    if(!lote) return;
    document.getElementById("lote-id").value = lote.id;
    document.getElementById("lote-nombre").value = lote.nombre;
    document.getElementById("lote-superficie").value = lote.superficie;
    document.getElementById("lote-suelo").value = lote.suelo;
    document.getElementById("lote-uso").value = lote.uso;
    document.getElementById("lote-ultimo-cultivo").value = lote.ultimoCultivo;
    document.getElementById("lote-fecha-siembra").value = lote.fechaSiembra || "";
    document.getElementById("lote-fecha-cosecha").value = lote.fechaCosecha || "";
    document.getElementById("lote-rinde").value = lote.rinde;
    document.getElementById("lotes-form-mode").textContent = "Edici√≥n";
    goToView("lotes");
  }
  function deleteLote(id){
    if(!confirm("¬øEliminar este lote?"))return;
    state.lots = state.lots.filter(l=>l.id!==id);
    saveState();
  }
  let lotesFilter = "all";
  function filterLotes(filter,ev){
    lotesFilter = filter;
    document.querySelectorAll("[data-filter-lote]").forEach(b=>b.classList.remove("active"));
    ev?.target.classList.add("active");
    renderLotesTable();
    renderLotesMap();
  }
  function renderLotesTable(){
    const tb = document.getElementById("tabla-lotes");
    tb.innerHTML = "";
    let rows = state.lots;
    if(lotesFilter==="agricola"){
      rows = rows.filter(l=> (l.uso || "").toLowerCase().match(/soja|ma[i√≠]z|trigo|girasol|sorgo/));
    } else if(lotesFilter==="ganadero"){
      rows = rows.filter(l=> (l.uso||"").toLowerCase().match(/pasto|pastura|alfalfa|ganado|verdeo/));
    }
    rows.forEach(l=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${l.nombre}</td>
        <td>${l.superficie || ""}</td>
        <td>${l.uso || ""}</td>
        <td>${l.ultimoCultivo || ""}</td>
        <td>${l.rinde || ""}</td>
        <td>
          <div class="actions">
            <button class="btn btn-sm" onclick="editLote('${l.id}')">‚úèÔ∏è</button>
            <button class="btn btn-sm" onclick="deleteLote('${l.id}')">üóëÔ∏è</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });
  }
  function renderLotesMap(){
    const cont = document.getElementById("lotes-map-grid");
    cont.innerHTML = "";
    state.lots.forEach(l=>{
      const uso = (l.uso||"").toLowerCase();
      let cls = "lote-otro";
      if(uso.match(/soja|ma[i√≠]z|trigo|girasol|sorgo/)) cls="lote-agricola";
      else if(uso.match(/pasto|pastura|alfalfa|ganado|verdeo/)) cls="lote-ganadero";
      else if(uso.match(/barbecho/)) cls="lote-barbecho";
      const div = document.createElement("div");
      div.className = "lote-box "+cls;
      div.innerHTML = `
        <strong>${l.nombre}</strong><br>
        <span>${l.superficie||0} ha</span><br>
        <span style="font-size:9px;">${l.uso||"Sin uso"}</span>
      `;
      cont.appendChild(div);
    });
  }

  // ========= LABORES =========
  function resetLaborForm(){
    document.getElementById("form-labor").reset();
    document.getElementById("labor-id").value = "";
    document.getElementById("labores-form-mode").textContent = "Alta";
  }
  function saveLabor(){
    const id = document.getElementById("labor-id").value || generateId("labor");
    const obj = {
      id,
      loteId:document.getElementById("labor-lote").value,
      tipo:document.getElementById("labor-tipo").value,
      fechaPlan:document.getElementById("labor-fecha-plan").value,
      fechaReal:document.getElementById("labor-fecha-real").value,
      estado:document.getElementById("labor-estado").value,
      maquinaId:document.getElementById("labor-maquina").value,
      operarioId:document.getElementById("labor-operario").value,
      horas:+(document.getElementById("labor-horas").value || 0),
      combustible:+(document.getElementById("labor-combustible").value || 0),
      obs:document.getElementById("labor-obs").value.trim()
    };
    if(!obj.loteId){
      alert("Seleccion√° un lote.");
      return;
    }
    const idx = state.labores.findIndex(l=>l.id===id);
    if(idx>=0) state.labores[idx] = obj; else state.labores.push(obj);
    saveState();
    resetLaborForm();
  }
  function editLabor(id){
    const lab = state.labores.find(l=>l.id===id);
    if(!lab) return;
    document.getElementById("labor-id").value = lab.id;
    document.getElementById("labor-lote").value = lab.loteId;
    document.getElementById("labor-tipo").value = lab.tipo;
    document.getElementById("labor-fecha-plan").value = lab.fechaPlan || "";
    document.getElementById("labor-fecha-real").value = lab.fechaReal || "";
    document.getElementById("labor-estado").value = lab.estado;
    document.getElementById("labor-maquina").value = lab.maquinaId || "";
    document.getElementById("labor-operario").value = lab.operarioId || "";
    document.getElementById("labor-horas").value = lab.horas || "";
    document.getElementById("labor-combustible").value = lab.combustible || "";
    document.getElementById("labor-obs").value = lab.obs || "";
    document.getElementById("labores-form-mode").textContent = "Edici√≥n";
    goToView("labores");
  }
  function deleteLabor(id){
    if(!confirm("¬øEliminar esta labor?"))return;
    state.labores = state.labores.filter(l=>l.id!==id);
    saveState();
  }
  let laboresFilter = "all";
  function filterLabores(filter,ev){
    laboresFilter = filter;
    document.querySelectorAll("[data-filter-labor]").forEach(b=>b.classList.remove("active"));
    ev?.target.classList.add("active");
    renderLaboresTable();
  }
  function renderLaboresTable(){
    const tb = document.getElementById("tabla-labores");
    tb.innerHTML = "";
    let rows = state.labores.slice().sort((a,b)=> (a.fechaPlan||"").localeCompare(b.fechaPlan||""));
    if(laboresFilter!=="all"){
      rows = rows.filter(l=>l.estado===laboresFilter);
    }
    rows.forEach(l=>{
      const lote = state.lots.find(x=>x.id===l.loteId);
      const maq = state.maquinaria.find(x=>x.id===l.maquinaId);
      const op = state.personal.find(x=>x.id===l.operarioId);
      let badgeClass = "yellow";
      if(l.estado==="Finalizada") badgeClass = "green";
      if(l.estado==="Pendiente") badgeClass = "red";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${l.fechaPlan || ""}</td>
        <td>${lote?lote.nombre:"-"}</td>
        <td>${l.tipo}</td>
        <td><span class="badge ${badgeClass}">${l.estado}</span></td>
        <td>${op?op.nombre:"-"}</td>
        <td>${maq?maq.nombre:"-"}</td>
        <td>${l.horas||""}</td>
        <td>${l.combustible||""}</td>
        <td>
          <div class="actions">
            <button class="btn btn-sm" onclick="editLabor('${l.id}')">‚úèÔ∏è</button>
            <button class="btn btn-sm" onclick="deleteLabor('${l.id}')">üóëÔ∏è</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  // ========= INSUMOS =========
  function resetInsumoForm(){
    document.getElementById("form-insumo").reset();
    document.getElementById("insumo-id").value = "";
    document.getElementById("insumos-form-mode").textContent = "Alta";
  }
  function saveInsumo(){
    const id = document.getElementById("insumo-id").value || generateId("ins");
    const obj = {
      id,
      nombre:document.getElementById("insumo-nombre").value.trim(),
      categoria:document.getElementById("insumo-categoria").value,
      unidad:document.getElementById("insumo-unidad").value.trim(),
      stock:+(document.getElementById("insumo-stock").value || 0),
      minimo:+(document.getElementById("insumo-minimo").value || 0),
      costo:+(document.getElementById("insumo-costo").value || 0)
    };
    if(!obj.nombre){
      alert("El insumo necesita nombre.");
      return;
    }
    const idx = state.insumos.findIndex(i=>i.id===id);
    if(idx>=0) state.insumos[idx]=obj; else state.insumos.push(obj);
    saveState();
    resetInsumoForm();
  }
  function editInsumo(id){
    const ins = state.insumos.find(i=>i.id===id);
    if(!ins) return;
    document.getElementById("insumo-id").value = ins.id;
    document.getElementById("insumo-nombre").value = ins.nombre;
    document.getElementById("insumo-categoria").value = ins.categoria;
    document.getElementById("insumo-unidad").value = ins.unidad;
    document.getElementById("insumo-stock").value = ins.stock;
    document.getElementById("insumo-minimo").value = ins.minimo;
    document.getElementById("insumo-costo").value = ins.costo;
    document.getElementById("insumos-form-mode").textContent = "Edici√≥n";
    goToView("insumos");
  }
  function deleteInsumo(id){
    if(!confirm("¬øEliminar este insumo?")) return;
    state.insumos = state.insumos.filter(i=>i.id!==id);
    saveState();
  }
  let insumosFilter = "all";
  function filterInsumos(filter,ev){
    insumosFilter = filter;
    document.querySelectorAll("[data-filter-insumo]").forEach(b=>b.classList.remove("active"));
    ev?.target.classList.add("active");
    renderInsumosTable();
  }
  function renderInsumosTable(){
    const tb = document.getElementById("tabla-insumos");
    tb.innerHTML = "";
    let rows = state.insumos;
    if(insumosFilter!=="all"){
      rows = rows.filter(i=>i.categoria===insumosFilter);
    }
    rows.forEach(ins=>{
      const critico = ins.stock <= ins.minimo && ins.minimo>0;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${ins.nombre}</td>
        <td>${ins.categoria}</td>
        <td>${ins.stock}</td>
        <td>${ins.minimo}</td>
        <td>${ins.unidad || ""}</td>
        <td>${ins.costo ? ins.costo.toFixed(2) : ""}</td>
        <td>${critico?'<span class="badge red">Cr√≠tico</span>':'<span class="badge green">OK</span>'}</td>
        <td>
          <div class="actions">
            <button class="btn btn-sm" onclick="editInsumo('${ins.id}')">‚úèÔ∏è</button>
            <button class="btn btn-sm" onclick="deleteInsumo('${ins.id}')">üóëÔ∏è</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  // ========= MAQUINARIA =========
  function resetMaquinariaForm(){
    document.getElementById("form-maq").reset();
    document.getElementById("maq-id").value="";
    document.getElementById("maq-form-mode").textContent="Alta";
  }
  function saveMaquinaria(){
    const id = document.getElementById("maq-id").value || generateId("maq");
    const obj = {
      id,
      nombre:document.getElementById("maq-nombre").value.trim(),
      tipo:document.getElementById("maq-tipo").value,
      marca:document.getElementById("maq-marca").value.trim(),
      modelo:document.getElementById("maq-modelo").value.trim(),
      anio:+(document.getElementById("maq-anio").value || 0),
      horas:+(document.getElementById("maq-horas").value || 0),
      nextService:+(document.getElementById("maq-next-service").value || 0),
      notas:document.getElementById("maq-notas").value.trim()
    };
    if(!obj.nombre){
      alert("La maquinaria necesita un nombre/alias.");
      return;
    }
    const idx = state.maquinaria.findIndex(m=>m.id===id);
    if(idx>=0) state.maquinaria[idx]=obj; else state.maquinaria.push(obj);
    saveState();
    resetMaquinariaForm();
  }
  function editMaquinaria(id){
    const m = state.maquinaria.find(x=>x.id===id);
    if(!m) return;
    document.getElementById("maq-id").value = m.id;
    document.getElementById("maq-nombre").value = m.nombre;
    document.getElementById("maq-tipo").value = m.tipo;
    document.getElementById("maq-marca").value = m.marca;
    document.getElementById("maq-modelo").value = m.modelo;
    document.getElementById("maq-anio").value = m.anio || "";
    document.getElementById("maq-horas").value = m.horas || "";
    document.getElementById("maq-next-service").value = m.nextService || "";
    document.getElementById("maq-notas").value = m.notas || "";
    document.getElementById("maq-form-mode").textContent = "Edici√≥n";
    goToView("maquinaria");
  }
  function deleteMaquinaria(id){
    if(!confirm("¬øEliminar este equipo?"))return;
    state.maquinaria = state.maquinaria.filter(m=>m.id!==id);
    saveState();
  }
  function renderMaquinariaTable(){
    const tb = document.getElementById("tabla-maquinaria");
    tb.innerHTML = "";
    state.maquinaria.forEach(m=>{
      let status = "OK";
      let badgeClass = "green";
      if(m.nextService && m.horas){
        const diff = m.nextService - m.horas;
        if(diff<=0){
          status = "Service vencido";
          badgeClass = "red";
        }else if(diff<=20){
          status = "Pr√≥x. service";
          badgeClass = "yellow";
        }
      }
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m.nombre}</td>
        <td>${m.tipo}</td>
        <td>${m.horas||""}</td>
        <td>${m.nextService||""}</td>
        <td><span class="badge ${badgeClass}">${status}</span></td>
        <td>
          <div class="actions">
            <button class="btn btn-sm" onclick="editMaquinaria('${m.id}')">‚úèÔ∏è</button>
            <button class="btn btn-sm" onclick="deleteMaquinaria('${m.id}')">üóëÔ∏è</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  // ========= PERSONAL =========
  function resetPersonalForm(){
    document.getElementById("form-personal").reset();
    document.getElementById("pers-id").value="";
    document.getElementById("personal-form-mode").textContent="Alta";
  }
  function savePersonal(){
    const id = document.getElementById("pers-id").value || generateId("pers");
    const obj = {
      id,
      nombre:document.getElementById("pers-nombre").value.trim(),
      rol:document.getElementById("pers-rol").value,
      tel:document.getElementById("pers-tel").value.trim(),
      notas:document.getElementById("pers-notas").value.trim()
    };
    if(!obj.nombre){
      alert("Falta nombre del personal.");
      return;
    }
    const idx = state.personal.findIndex(p=>p.id===id);
    if(idx>=0) state.personal[idx]=obj; else state.personal.push(obj);
    saveState();
    resetPersonalForm();
  }
  function editPersonal(id){
    const p = state.personal.find(x=>x.id===id);
    if(!p) return;
    document.getElementById("pers-id").value = p.id;
    document.getElementById("pers-nombre").value = p.nombre;
    document.getElementById("pers-rol").value = p.rol;
    document.getElementById("pers-tel").value = p.tel;
    document.getElementById("pers-notas").value = p.notas;
    document.getElementById("personal-form-mode").textContent = "Edici√≥n";
    goToView("personal");
  }
  function deletePersonal(id){
    if(!confirm("¬øEliminar este operario?"))return;
    state.personal = state.personal.filter(p=>p.id!==id);
    saveState();
  }
  function renderPersonalTable(){
    const tb = document.getElementById("tabla-personal");
    tb.innerHTML = "";
    state.personal.forEach(p=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.nombre}</td>
        <td>${p.rol}</td>
        <td>${p.tel||""}</td>
        <td>
          <div class="actions">
            <button class="btn btn-sm" onclick="editPersonal('${p.id}')">‚úèÔ∏è</button>
            <button class="btn btn-sm" onclick="deletePersonal('${p.id}')">üóëÔ∏è</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  // ========= GANADER√çA =========
  function resetRodeoForm(){
    document.getElementById("form-rodeo").reset();
    document.getElementById("rodeo-id").value="";
  }
  function saveRodeo(){
    const id = document.getElementById("rodeo-id").value || generateId("rodeo");
    const obj = {
      id,
      nombre:document.getElementById("rodeo-nombre").value.trim(),
      categoria:document.getElementById("rodeo-cat").value,
      potrero:document.getElementById("rodeo-potrero").value.trim(),
      cantidad:+(document.getElementById("rodeo-cant").value || 0)
    };
    if(!obj.nombre){
      alert("El rodeo necesita un nombre.");
      return;
    }
    const idx = state.rodeos.findIndex(r=>r.id===id);
    if(idx>=0) state.rodeos[idx]=obj; else state.rodeos.push(obj);
    saveState();
    resetRodeoForm();
  }
  function editRodeo(id){
    const r = state.rodeos.find(x=>x.id===id);
    if(!r)return;
    document.getElementById("rodeo-id").value = r.id;
    document.getElementById("rodeo-nombre").value = r.nombre;
    document.getElementById("rodeo-cat").value = r.categoria;
    document.getElementById("rodeo-potrero").value = r.potrero;
    document.getElementById("rodeo-cant").value = r.cantidad;
  }
  function deleteRodeo(id){
    if(!confirm("¬øEliminar rodeo?"))return;
    state.rodeos = state.rodeos.filter(r=>r.id!==id);
    saveState();
  }
  function resetMovGanadoForm(){
    document.getElementById("form-mov-ganado").reset();
    document.getElementById("movgan-id").value="";
  }
  function saveMovGanado(){
    const id = document.getElementById("movgan-id").value || generateId("movgan");
    const obj = {
      id,
      fecha:document.getElementById("movgan-fecha").value,
      tipo:document.getElementById("movgan-tipo").value,
      rodeoId:document.getElementById("movgan-rodeo").value,
      cantidad:+(document.getElementById("movgan-cant").value || 0),
      notas:document.getElementById("movgan-notas").value.trim()
    };
    if(!obj.rodeoId){
      alert("Eleg√≠ un rodeo.");
      return;
    }
    const idx = state.movGanado.findIndex(m=>m.id===id);
    if(idx>=0) state.movGanado[idx]=obj; else state.movGanado.push(obj);
    const rodeo = state.rodeos.find(r=>r.id===obj.rodeoId);
    if(rodeo){
      if(obj.tipo==="Compra" || obj.tipo==="Nacimientos") rodeo.cantidad += obj.cantidad;
      if(obj.tipo==="Venta" || obj.tipo==="Muerte") rodeo.cantidad -= obj.cantidad;
      if(rodeo.cantidad<0) rodeo.cantidad = 0;
    }
    saveState();
    resetMovGanadoForm();
  }
  function deleteMovGanado(id){
    if(!confirm("¬øEliminar movimiento?"))return;
    state.movGanado = state.movGanado.filter(m=>m.id!==id);
    saveState();
  }
  function renderGanaderia(){
    const sel = document.getElementById("movgan-rodeo");
    sel.innerHTML = `<option value="">Seleccionar...</option>`;
    state.rodeos.forEach(r=>{
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = r.nombre;
      sel.appendChild(opt);
    });

    const tbR = document.getElementById("tabla-rodeos");
    tbR.innerHTML = "";
    state.rodeos.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.nombre}</td>
        <td>${r.categoria}</td>
        <td>${r.potrero||""}</td>
        <td>${r.cantidad||0}</td>
        <td>
          <div class="actions">
            <button class="btn btn-sm" onclick="editRodeo('${r.id}')">‚úèÔ∏è</button>
            <button class="btn btn-sm" onclick="deleteRodeo('${r.id}')">üóëÔ∏è</button>
          </div>
        </td>
      `;
      tbR.appendChild(tr);
    });

    const tbM = document.getElementById("tabla-mov-ganado");
    tbM.innerHTML = "";
    state.movGanado.slice().sort((a,b)=>(b.fecha||"").localeCompare(a.fecha||"")).forEach(m=>{
      const r = state.rodeos.find(x=>x.id===m.rodeoId);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m.fecha||""}</td>
        <td>${m.tipo}</td>
        <td>${r?r.nombre:"-"}</td>
        <td>${m.cantidad}</td>
        <td>
          <div class="actions">
            <button class="btn btn-sm" onclick="deleteMovGanado('${m.id}')">üóëÔ∏è</button>
          </div>
        </td>
      `;
      tbM.appendChild(tr);
    });
  }

  // ========= FINANZAS =========
  function resetIngresoForm(){
    document.getElementById("form-ingreso").reset();
    document.getElementById("ing-id").value="";
  }
  function saveIngreso(){
    const id = document.getElementById("ing-id").value || generateId("ing");
    const obj = {
      id,
      fecha:document.getElementById("ing-fecha").value,
      monto:+(document.getElementById("ing-monto").value || 0),
      concepto:document.getElementById("ing-concepto").value.trim(),
      campana:document.getElementById("ing-campana").value.trim()
    };
    if(!obj.monto){
      alert("El ingreso necesita un monto.");
      return;
    }
    const idx = state.ingresos.findIndex(i=>i.id===id);
    if(idx>=0) state.ingresos[idx]=obj; else state.ingresos.push(obj);
    saveState();
    resetIngresoForm();
  }
  function resetEgresoForm(){
    document.getElementById("form-egreso").reset();
    document.getElementById("egr-id").value="";
  }
  function saveEgreso(){
    const id = document.getElementById("egr-id").value || generateId("egr");
    const obj = {
      id,
      fecha:document.getElementById("egr-fecha").value,
      monto:+(document.getElementById("egr-monto").value || 0),
      concepto:document.getElementById("egr-concepto").value.trim(),
      campana:document.getElementById("egr-campana").value.trim()
    };
    if(!obj.monto){
      alert("El egreso necesita monto.");
      return;
    }
    const idx = state.egresos.findIndex(i=>i.id===id);
    if(idx>=0) state.egresos[idx]=obj; else state.egresos.push(obj);
    saveState();
    resetEgresoForm();
  }
  function deleteIngreso(id){
    if(!confirm("¬øEliminar ingreso?"))return;
    state.ingresos = state.ingresos.filter(i=>i.id!==id);
    saveState();
  }
  function deleteEgreso(id){
    if(!confirm("¬øEliminar egreso?"))return;
    state.egresos = state.egresos.filter(i=>i.id!==id);
    saveState();
  }
  function renderFinanzasTablas(){
    const tbIng = document.getElementById("tabla-ingresos");
    const tbEgr = document.getElementById("tabla-egresos");
    tbIng.innerHTML = "";
    tbEgr.innerHTML = "";
    state.ingresos.slice().sort((a,b)=>(b.fecha||"").localeCompare(a.fecha||"")).forEach(i=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i.fecha||""}</td>
        <td>${i.campana||""}</td>
        <td>${i.concepto||""}</td>
        <td class="text-right">${i.monto.toFixed(2)}</td>
        <td><button class="btn btn-sm" onclick="deleteIngreso('${i.id}')">üóëÔ∏è</button></td>
      `;
      tbIng.appendChild(tr);
    });
    state.egresos.slice().sort((a,b)=>(b.fecha||"").localeCompare(a.fecha||"")).forEach(i=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i.fecha||""}</td>
        <td>${i.campana||""}</td>
        <td>${i.concepto||""}</td>
        <td class="text-right">${i.monto.toFixed(2)}</td>
        <td><button class="btn btn-sm" onclick="deleteEgreso('${i.id}')">üóëÔ∏è</button></td>
      `;
      tbEgr.appendChild(tr);
    });
  }
  function updateFinanzasResumen(){
    const campFiltro = document.getElementById("fin-campana-filtro").value.trim() || state.settings.campaign;
    const ing = state.ingresos.filter(i=>!campFiltro || i.campana===campFiltro);
    const egr = state.egresos.filter(i=>!campFiltro || i.campana===campFiltro);
    const sumIng = ing.reduce((acc,x)=>acc+x.monto,0);
    const sumEgr = egr.reduce((acc,x)=>acc+x.monto,0);
    const res = sumIng - sumEgr;
    document.getElementById("fin-kpi-ingresos").textContent = sumIng.toFixed(2);
    document.getElementById("fin-kpi-egresos").textContent = sumEgr.toFixed(2);
    document.getElementById("fin-kpi-resultado").textContent = res.toFixed(2);
    document.getElementById("chart-fin-label").textContent = "Campa√±a "+(campFiltro||"");
    updateCharts();
  }

  // ========= CONFIG / BACKUP =========
  function saveCampana(){
    const camp = document.getElementById("cfg-campana").value.trim();
    if(!camp){
      alert("Escrib√≠ un nombre de campa√±a.");
      return;
    }
    state.settings.campaign = camp;
    saveState();
  }
  function downloadBackup(){
    const blob = new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "backup_campo40_"+new Date().toISOString().slice(0,10)+".json";
    a.click();
  }
  function importBackup(ev){
    const file = ev.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
      try{
        const data = JSON.parse(e.target.result);
        if(confirm("Esto va a reemplazar los datos actuales. ¬øSeguro?")){
          state = Object.assign(state, data);
          saveState();
        }
      }catch(err){
        alert("Error leyendo el backup.");
        console.error(err);
      }
    };
    reader.readAsText(file);
  }
  function clearAllData(){
    if(!confirm("Esto borra TODO lo del campo en este navegador. ¬øSeguro?"))return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  // ========= DASHBOARD =========
  function buildAlerts(){
    const alerts = [];
    state.insumos.forEach(i=>{
      if(i.minimo>0 && i.stock <= i.minimo){
        alerts.push({tipo:"insumo", texto:`Stock cr√≠tico de ${i.nombre} (${i.stock} ${i.unidad||""})`});
      }
    });
    state.maquinaria.forEach(m=>{
      if(m.nextService && m.horas){
        const diff = m.nextService - m.horas;
        if(diff<=0){
          alerts.push({tipo:"maq", texto:`Service vencido en ${m.nombre} (${m.horas}h / ${m.nextService}h)`});
        }else if(diff<=20){
          alerts.push({tipo:"maq", texto:`Service cerca en ${m.nombre}: faltan ${diff}h`});
        }
      }
    });
    const today = new Date().toISOString().slice(0,10);
    state.labores.forEach(l=>{
      if(l.estado!=="Finalizada" && l.fechaPlan && l.fechaPlan < today){
        const lote = state.lots.find(x=>x.id===l.loteId);
        alerts.push({tipo:"labor", texto:`Labor atrasada: ${l.tipo} en ${lote?lote.nombre:""} (${l.fechaPlan})`});
      }
    });
    return alerts;
  }
  function renderDashboard(){
    document.getElementById("dash-lotes-count").textContent = state.lots.length;
    const pendientes = state.labores.filter(l=>l.estado==="Pendiente").length;
    document.getElementById("dash-labores-pendientes").textContent = pendientes;
    const criticos = state.insumos.filter(i=>i.minimo>0 && i.stock <= i.minimo).length;
    document.getElementById("dash-insumos-criticos").textContent = criticos;

    document.getElementById("dash-campaign-tag").textContent = "Campa√±a " + (state.settings.campaign || "s/d");
    document.getElementById("cfg-campana").value = state.settings.campaign || "";
    document.getElementById("fin-campana-filtro").value = state.settings.campaign || "";

    const alerts = buildAlerts();
    document.getElementById("dash-alert-count").textContent = alerts.length + " activas";
    const ul = document.getElementById("dash-alert-list");
    ul.innerHTML = "";
    if(alerts.length===0){
      const li = document.createElement("li");
      li.textContent = "Sin alertas graves por ahora. El campo respira. üòé";
      ul.appendChild(li);
    }else{
      alerts.slice(0,8).forEach(a=>{
        const li = document.createElement("li");
        li.textContent = "‚Ä¢ " + a.texto;
        ul.appendChild(li);
      });
    }

    const tb = document.getElementById("dash-proximas-labores");
    tb.innerHTML = "";
    const hoy = new Date();
    const en7 = new Date();
    en7.setDate(hoy.getDate()+7);
    const rows = state.labores.filter(l=>{
      if(!l.fechaPlan) return false;
      const d = new Date(l.fechaPlan);
      return d>=hoy && d<=en7;
    }).sort((a,b)=>(a.fechaPlan||"").localeCompare(b.fechaPlan||""));
    rows.forEach(l=>{
      const lote = state.lots.find(x=>x.id===l.loteId);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${l.fechaPlan}</td>
        <td>${lote?lote.nombre:"-"}</td>
        <td>${l.tipo}</td>
        <td>${l.estado}</td>
      `;
      tb.appendChild(tr);
    });
  }

  // ========= RELLENO SELECTS =========
  function refreshSelects(){
    const selLote = document.getElementById("labor-lote");
    const selMaq = document.getElementById("labor-maquina");
    const selOp = document.getElementById("labor-operario");

    selLote.innerHTML = `<option value="">Seleccionar lote...</option>`;
    state.lots.forEach(l=>{
      const opt = document.createElement("option");
      opt.value = l.id;
      opt.textContent = l.nombre;
      selLote.appendChild(opt);
    });

    selMaq.innerHTML = `<option value="">(Opcional)</option>`;
    state.maquinaria.forEach(m=>{
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = m.nombre;
      selMaq.appendChild(opt);
    });

    selOp.innerHTML = `<option value="">(Opcional)</option>`;
    state.personal.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.nombre;
      selOp.appendChild(opt);
    });
  }

  // ========= GR√ÅFICOS =========
  let chartRinde = null;
  let chartFin = null;

  function updateCharts(){
    const ctxR = document.getElementById("chart-rinde-lotes");
    const ctxF = document.getElementById("chart-finanzas");
    if(!ctxR || !ctxF || typeof Chart === "undefined") return;

    // Rinde por lote
    const lotsWithRinde = state.lots.filter(l=>l.rinde && l.rinde>0);
    const labelsR = lotsWithRinde.map(l=>l.nombre);
    const dataR = lotsWithRinde.map(l=>l.rinde);
    if(chartRinde) chartRinde.destroy();
    chartRinde = new Chart(ctxR,{
      type:"bar",
      data:{
        labels:labelsR,
        datasets:[{
          label:"Rinde promedio (qq/ha)",
          data:dataR
        }]
      },
      options:{
        responsive:true,
        plugins:{
          legend:{display:false}
        },
        scales:{
          x:{ticks:{font:{size:10}}},
          y:{beginAtZero:true}
        }
      }
    });

    // Finanzas: ingresos vs egresos campa√±a filtro
    const campFiltro = document.getElementById("fin-campana-filtro").value.trim() || state.settings.campaign;
    const ing = state.ingresos.filter(i=>!campFiltro || i.campana===campFiltro);
    const egr = state.egresos.filter(i=>!campFiltro || i.campana===campFiltro);
    const sumIng = ing.reduce((acc,x)=>acc+x.monto,0);
    const sumEgr = egr.reduce((acc,x)=>acc+x.monto,0);

    if(chartFin) chartFin.destroy();
    chartFin = new Chart(ctxF,{
      type:"bar",
      data:{
        labels:["Ingresos","Egresos"],
        datasets:[{
          label:"USD",
          data:[sumIng,sumEgr]
        }]
      },
      options:{
        responsive:true,
        plugins:{
          legend:{display:false}
        },
        scales:{
          y:{beginAtZero:true}
        }
      }
    });
  }

  // ========= UPDATE GENERAL =========
  function updateAllViews(){
    renderLotesTable();
    renderLotesMap();
    renderLaboresTable();
    renderInsumosTable();
    renderMaquinariaTable();
    renderPersonalTable();
    renderGanaderia();
    renderFinanzasTablas();
    updateFinanzasResumen();
    renderDashboard();
    refreshSelects();
    updateCharts();
  }

  // ========= INIT =========
  loadState();
  updateDateTime();
  updateAllViews();
</script>
</body>
</html>