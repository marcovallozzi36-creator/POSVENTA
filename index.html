<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>üõí Lista de S√∫per con Esc√°ner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <!-- ZXing para leer c√≥digos de barras (desde CDN) -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-soft: #0b1120;
      --card: #020617;
      --accent: #22c55e;
      --accent-soft: #16a34a;
      --danger: #ef4444;
      --warn: #f97316;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.65);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 40%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      padding: 12px 10px 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    header {
      padding: 10px 14px;
      border-radius: 16px;
      background: linear-gradient(135deg, #0f172a, #020617);
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    header .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    header h1 {
      margin: 0;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    header h1 span {
      font-size: 1.35rem;
    }

    header p {
      margin: 0;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .pill {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.68rem;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      min-height: 0;
    }

    .card {
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #020617 100%);
      border-radius: 16px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      padding: 10px 12px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.7);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .card-header h2 {
      font-size: 0.95rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-header small {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease, opacity 0.1s ease;
      user-select: none;
      -webkit-user-select: none;
    }

    .btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #022c22;
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.55);
      border: 1px solid rgba(22, 163, 74, 0.9);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.96);
      color: var(--text);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .btn-danger {
      background: rgba(127, 29, 29, 0.95);
      color: #fee2e2;
      border: 1px solid rgba(248, 113, 113, 0.85);
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 0.75rem;
    }

    .btn[disabled] {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .scanner-container {
      margin-top: 6px;
      border-radius: 14px;
      overflow: hidden;
      background: #020617;
      border: 1px solid rgba(31, 41, 55, 0.9);
      position: relative;
      display: none;
      flex-direction: column;
      gap: 6px;
    }

    .scanner-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 9px 4px;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .scanner-header span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .scanner-header .dot-live {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34, 197, 94, 1);
    }

    .scanner-video-wrapper {
      position: relative;
      width: 100%;
      max-height: 260px;
      overflow: hidden;
    }

    video {
      width: 100%;
      display: block;
      background: #000;
      object-fit: cover;
    }

    .scan-overlay {
      position: absolute;
      inset: 18%;
      border-radius: 12px;
      border: 2px solid rgba(34, 197, 94, 0.85);
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.6);
      pointer-events: none;
    }

    .scan-line {
      position: absolute;
      left: 15%;
      right: 15%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #22c55e, transparent);
      box-shadow: 0 0 16px rgba(34, 197, 94, 0.9);
      animation: scanMove 2.1s linear infinite;
    }

    @keyframes scanMove {
      0% {
        top: 20%;
      }
      50% {
        top: 75%;
      }
      100% {
        top: 20%;
      }
    }

    .scanner-footer {
      padding: 4px 9px 8px;
      font-size: 0.7rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .scanner-footer strong {
      color: var(--accent);
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 2px;
    }

    .field-row {
      display: flex;
      gap: 6px;
    }

    input[type="text"],
    input[type="number"] {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
    }

    input::placeholder {
      color: #6b7280;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.6);
    }

    .list-container {
      max-height: 52vh;
      overflow-y: auto;
      padding-right: 2px;
      margin-top: 4px;
    }

    .list-empty {
      font-size: 0.8rem;
      color: var(--muted);
      padding: 6px 2px 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    ul.items {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 9px;
      border-radius: 12px;
      background: radial-gradient(circle at top left, #0b1120 0, #020617 45%, #020617 100%);
      border: 1px solid rgba(31, 41, 55, 0.95);
    }

    .item-main {
      flex: 1;
      min-width: 0;
    }

    .item-top {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
    }

    .item-name {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .item-name.empty {
      color: var(--muted);
      font-style: italic;
    }

    .item-code {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .item-bottom {
      margin-top: 2px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .qty-badge {
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15, 23, 42, 0.95);
      font-size: 0.75rem;
    }

    .item-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .item-actions button {
      min-width: 28px;
    }

    .checkbox-wrap {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #22c55e;
    }

    .item.done {
      opacity: 0.6;
    }

    .item.done .item-name {
      text-decoration: line-through;
    }

    .footer-row {
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .footer-row strong {
      color: var(--accent);
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(22, 163, 74, 0.96);
      color: #022c22;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 12px 30px rgba(22, 163, 74, 0.8);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease, transform 0.15s ease;
      z-index: 9999;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    @media (max-width: 380px) {
      header h1 {
        font-size: 1rem;
      }
      .card-header h2 {
        font-size: 0.9rem;
      }
      .scanner-video-wrapper {
        max-height: 220px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-block">
        <h1><span>üõí</span> Lista S√∫per Pro</h1>
        <p>Escane√° c√≥digos y arm√° tu lista desde el celu.</p>
      </div>
      <div class="pill">
        <div class="pill-dot"></div>
        Live ¬∑ Modo Shopper
      </div>
    </header>

    <main>
      <!-- SCAN CARD -->
      <section class="card" id="scan-card">
        <div class="card-header">
          <h2>üì∑ Escanear producto</h2>
          <small id="camera-status-text">C√°mara lista</small>
        </div>

        <button class="btn btn-primary" id="btn-start-scan">
          üì∑ Escanear c√≥digo
        </button>
        <button class="btn btn-secondary btn-sm" id="btn-stop-scan" style="margin-top:6px; display:none;">
          ‚èπÔ∏è Detener esc√°ner
        </button>

        <div class="scanner-container" id="scanner-container">
          <div class="scanner-header">
            <span><span class="dot-live"></span> Escaneando‚Ä¶</span>
            <span id="camera-name">C√°mara trasera</span>
          </div>
          <div class="scanner-video-wrapper">
            <video id="video" playsinline></video>
            <div class="scan-overlay"></div>
            <div class="scan-line"></div>
          </div>
          <div class="scanner-footer">
            <span>Apunt√° el c√≥digo dentro del recuadro üëÜ</span>
            <span>√öltimo: <strong id="last-code">‚Äì</strong></span>
          </div>
        </div>
      </section>

      <!-- ADD MANUAL CARD -->
      <section class="card">
        <div class="card-header">
          <h2>‚ûï Agregar manual</h2>
          <small>Por si el c√≥digo falla o quer√©s algo r√°pido.</small>
        </div>
        <form id="manual-form">
          <div class="field-row">
            <input
              type="text"
              id="manual-name"
              placeholder="Nombre del producto"
              autocomplete="off"
              required
            />
          </div>
          <div class="field-row">
            <input
              type="number"
              id="manual-qty"
              min="1"
              step="1"
              value="1"
            />
            <button type="submit" class="btn btn-secondary">
              ‚úÖ Agregar
            </button>
          </div>
        </form>
      </section>

      <!-- LIST CARD -->
      <section class="card" style="flex:1; display:flex; flex-direction:column; min-height:0;">
        <div class="card-header">
          <h2>üìã Mi lista</h2>
          <small id="summary-text">0 productos</small>
        </div>

        <div class="list-container">
          <div id="empty-state" class="list-empty">
            üß∫ Todav√≠a no agregaste nada. Empez√° escaneando o cargando manualmente.
          </div>
          <ul class="items" id="items-list"></ul>
        </div>

        <div class="footer-row">
          <span id="items-counter">0 de 0 comprados</span>
          <button class="btn btn-danger btn-sm" id="btn-clear">
            üóëÔ∏è Vaciar lista
          </button>
        </div>
      </section>
    </main>
  </div>

  <div class="toast" id="toast">
    ‚úÖ Producto agregado
  </div>

  <script>
    // ---------------------------
    // Estado y helpers
    // ---------------------------
    const STORAGE_KEY = "listaSuperScanner_v1";
    let items = [];
    let codeReader = null;
    let currentDeviceId = null;
    let scanning = false;

    const btnStartScan = document.getElementById("btn-start-scan");
    const btnStopScan = document.getElementById("btn-stop-scan");
    const scannerContainer = document.getElementById("scanner-container");
    const videoElement = document.getElementById("video");
    const lastCodeEl = document.getElementById("last-code");
    const cameraStatusText = document.getElementById("camera-status-text");
    const cameraNameEl = document.getElementById("camera-name");

    const manualForm = document.getElementById("manual-form");
    const manualNameInput = document.getElementById("manual-name");
    const manualQtyInput = document.getElementById("manual-qty");

    const itemsListEl = document.getElementById("items-list");
    const emptyStateEl = document.getElementById("empty-state");
    const summaryTextEl = document.getElementById("summary-text");
    const itemsCounterEl = document.getElementById("items-counter");
    const btnClear = document.getElementById("btn-clear");
    const toastEl = document.getElementById("toast");

    function showToast(message) {
      toastEl.textContent = message;
      toastEl.classList.add("show");
      setTimeout(() => {
        toastEl.classList.remove("show");
      }, 1500);
    }

    function saveItems() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    function loadItems() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          items = JSON.parse(raw) || [];
        } else {
          items = [];
        }
      } catch (e) {
        console.error("Error leyendo localStorage", e);
        items = [];
      }
      renderItems();
    }

    function createItem({ code = null, name = "", qty = 1, done = false }) {
      return {
        id: Date.now().toString(36) + Math.random().toString(16).slice(2),
        code,
        name,
        qty: qty || 1,
        done: !!done,
      };
    }

    function addItem(item) {
      items.push(item);
      saveItems();
      renderItems();
    }

    function updateItem(id, changes) {
      const idx = items.findIndex((it) => it.id === id);
      if (idx === -1) return;
      items[idx] = { ...items[idx], ...changes };
      saveItems();
      renderItems();
    }

    function removeItem(id) {
      items = items.filter((it) => it.id !== id);
      saveItems();
      renderItems();
    }

    function clearItems() {
      if (!items.length) return;
      const ok = confirm("¬øVaciar toda la lista?");
      if (!ok) return;
      items = [];
      saveItems();
      renderItems();
    }

    function renderItems() {
      itemsListEl.innerHTML = "";

      if (!items.length) {
        emptyStateEl.style.display = "flex";
      } else {
        emptyStateEl.style.display = "none";
      }

      let doneCount = 0;
      let totalQty = 0;

      items.forEach((item) => {
        if (item.done) doneCount++;
        totalQty += Number(item.qty) || 0;

        const li = document.createElement("li");
        li.className = "item" + (item.done ? " done" : "");
        li.dataset.id = item.id;

        const checkboxWrap = document.createElement("div");
        checkboxWrap.className = "checkbox-wrap";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = item.done;
        checkbox.dataset.action = "toggle-done";
        checkboxWrap.appendChild(checkbox);

        const main = document.createElement("div");
        main.className = "item-main";

        const top = document.createElement("div");
        top.className = "item-top";

        const nameSpan = document.createElement("span");
        nameSpan.className = "item-name" + (item.name ? "" : " empty");
        nameSpan.textContent = item.name || "Sin nombre";
        top.appendChild(nameSpan);

        if (item.code) {
          const codeSpan = document.createElement("span");
          codeSpan.className = "item-code";
          codeSpan.textContent = "¬∑ " + item.code;
          top.appendChild(codeSpan);
        }

        const bottom = document.createElement("div");
        bottom.className = "item-bottom";

        const qtySpan = document.createElement("span");
        qtySpan.className = "qty-badge";
        qtySpan.textContent = "Cantidad: " + (item.qty || 1);
        bottom.appendChild(qtySpan);

        const infoSpan = document.createElement("span");
        infoSpan.textContent = item.done ? "‚úîÔ∏è Comprado" : "üïí Pendiente";
        bottom.appendChild(infoSpan);

        main.appendChild(top);
        main.appendChild(bottom);

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const btnEdit = document.createElement("button");
        btnEdit.className = "btn btn-secondary btn-sm";
        btnEdit.textContent = "‚úèÔ∏è";
        btnEdit.title = "Editar nombre / cantidad";
        btnEdit.dataset.action = "edit";

        const btnDelete = document.createElement("button");
        btnDelete.className = "btn btn-danger btn-sm";
        btnDelete.textContent = "üóëÔ∏è";
        btnDelete.title = "Eliminar";
        btnDelete.dataset.action = "delete";

        actions.appendChild(btnEdit);
        actions.appendChild(btnDelete);

        li.appendChild(checkboxWrap);
        li.appendChild(main);
        li.appendChild(actions);

        itemsListEl.appendChild(li);
      });

      summaryTextEl.textContent = `${items.length} productos ¬∑ ${totalQty} unidades`;
      itemsCounterEl.textContent = `${doneCount} de ${items.length} comprados`;
    }

    // ---------------------------
    // L√≥gica de escaneo
    // ---------------------------
    async function initCodeReaderIfNeeded() {
      if (codeReader) return;
      if (!window.ZXing || !ZXing.BrowserMultiFormatReader) {
        alert("No se pudo cargar el lector de c√≥digos. Revis√° tu conexi√≥n.");
        return;
      }
      codeReader = new ZXing.BrowserMultiFormatReader();
    }

    async function startScanner() {
      try {
        await initCodeReaderIfNeeded();
        if (!codeReader) return;

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert("Tu navegador no permite usar la c√°mara desde la web.");
          return;
        }

        cameraStatusText.textContent = "Buscando c√°mara‚Ä¶";

        const devices = await codeReader.listVideoInputDevices();
        if (!devices || !devices.length) {
          alert("No se encontraron c√°maras en este dispositivo.");
          cameraStatusText.textContent = "Sin c√°mara";
          return;
        }

        let deviceIdToUse = devices[0].deviceId;
        const backCam = devices.find((d) =>
          (d.label || "").toLowerCase().includes("back")
        );
        if (backCam) deviceIdToUse = backCam.deviceId;

        currentDeviceId = deviceIdToUse;

        const deviceLabel =
          (devices.find((d) => d.deviceId === deviceIdToUse)?.label ||
            "C√°mara") || "C√°mara";
        cameraNameEl.textContent =
          deviceLabel.length > 30
            ? deviceLabel.slice(0, 30) + "‚Ä¶"
            : deviceLabel;

        scannerContainer.style.display = "flex";
        btnStartScan.disabled = true;
        btnStopScan.style.display = "inline-flex";
        cameraStatusText.textContent = "Escaneando‚Ä¶";
        scanning = true;

        lastCodeEl.textContent = "‚Äì";

        await codeReader.decodeFromVideoDevice(
          deviceIdToUse,
          videoElement,
          (result, err) => {
            if (!scanning) return;

            if (result) {
              const value = result.text;
              lastCodeEl.textContent = value;

              handleScannedCode(value);
            }
            // errores se ignoran (son normales mientras no encuentra c√≥digo)
          }
        );
      } catch (err) {
        console.error("Error al iniciar el esc√°ner", err);
        alert(
          "No se pudo iniciar la c√°mara. Revis√° permisos o prob√° con otro navegador."
        );
        stopScanner();
      }
    }

    function stopScanner() {
      scanning = false;

      if (codeReader) {
        try {
          codeReader.reset();
        } catch (e) {
          console.warn("Error reseteando codeReader", e);
        }
      }

      if (videoElement && videoElement.srcObject) {
        try {
          const tracks = videoElement.srcObject.getTracks();
          tracks.forEach((t) => t.stop());
        } catch (e) {
          console.warn("Error parando tracks de video", e);
        }
        videoElement.srcObject = null;
      }

      scannerContainer.style.display = "none";
      btnStartScan.disabled = false;
      btnStopScan.style.display = "none";
      cameraStatusText.textContent = "C√°mara lista";
    }

    function handleScannedCode(code) {
      if (!code) return;

      // ¬øYa existe ese c√≥digo? -> sumo cantidad
      const existing = items.find((it) => it.code === code);
      if (existing) {
        const newQty = (Number(existing.qty) || 0) + 1;
        updateItem(existing.id, { qty: newQty });
        showToast("üîÅ Cantidad aumentada");
        return;
      }

      // Si no existe, creo un item nuevo preguntando nombre
      const name = prompt(
        "C√≥digo detectado:\n" +
          code +
          "\n\nOpcional: escrib√≠ un nombre para el producto (o dejalo vac√≠o):"
      );

      const item = createItem({
        code,
        name: (name || "").trim(),
        qty: 1,
        done: false,
      });

      addItem(item);
      showToast("‚úÖ Producto agregado");
    }

    // ---------------------------
    // Eventos UI
    // ---------------------------
    btnStartScan.addEventListener("click", () => {
      startScanner();
    });

    btnStopScan.addEventListener("click", () => {
      stopScanner();
    });

    manualForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = manualNameInput.value.trim();
      if (!name) return;

      const qty = Number(manualQtyInput.value) || 1;

      const item = createItem({
        code: null,
        name,
        qty,
        done: false,
      });

      addItem(item);
      manualNameInput.value = "";
      manualQtyInput.value = "1";
      showToast("‚úÖ Producto agregado");
      manualNameInput.blur();
    });

    btnClear.addEventListener("click", clearItems);

    itemsListEl.addEventListener("click", (e) => {
      const target = e.target;
      const li = target.closest(".item");
      if (!li) return;
      const id = li.dataset.id;
      if (!id) return;

      const action = target.dataset.action;
      if (action === "toggle-done") {
        const checked = target.checked;
        updateItem(id, { done: checked });
      } else if (action === "edit") {
        const item = items.find((it) => it.id === id);
        if (!item) return;

        const newName = prompt(
          "Editar nombre del producto:",
          item.name || ""
        );
        if (newName === null) return;

        const newQtyStr = prompt(
          "Editar cantidad:",
          String(item.qty || 1)
        );
        if (newQtyStr === null) return;

        const newQty = Number(newQtyStr) || 1;

        updateItem(id, { name: newName.trim(), qty: newQty });
      } else if (action === "delete") {
        const ok = confirm("¬øEliminar este producto?");
        if (!ok) return;
        removeItem(id);
      }
    });

    window.addEventListener("beforeunload", () => {
      stopScanner();
    });

    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        stopScanner();
      }
    });

    // ---------------------------
    // Init
    // ---------------------------
    loadItems();
  </script>
</body>
</html>